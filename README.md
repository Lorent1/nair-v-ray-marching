# RayMarching algorithm

## Установка

```shell
git clone https://github.com/Lorent1/nair-v-ray-marching
cd nair-v-ray-marching
git submodule init
git submodule update
```

Установить `Vulkan SDK`, если он не установлен (https://vulkan.lunarg.com/)

## Сборка и запуск

### CPU

``` shell
mkdir cmake-build-cpu-release && cd cmake-build-cpu-release
cmake -DCMAKE_BUILD_TYPE=Release ..
make -j 8
```

После сборки следует использовать `launch cpu` или `launch multicpu` в vs code для соответствующих режимов запуска

### GPU
```shell
mkdir cmake-build-gpu-release && cd cmake-build-gpu-release
cmake -DCMAKE_BUILD_TYPE=Release -DUSE_VULKAN=ON ..
make -j 8
```
После сборки следует использовать `launch gpu` в vs code для соответствующего режима запуска

## Зависимости
* `external/json` - nlohman-json библиотека для работы с json файлами
* `external/LiteMath` - библиотека для работы с векторами
* `external/vk-utils` - библиотека с полезными функциями для Vulkan
* `external/volk` - библиотека для Vulkan

## Реализация

### Функиционал

+ Функция расстояния со знаком `(SDF)`
+ Набор примитивов, содержащий данные виды sdf функций: `sphere`, `box`, `round box`, `mengerSponge`, `mandelbulb`, `plane`
+ Функии для работы с примитивами: `union` - объединение (жесткое, мягкое), `intersection` - пересечение (жесткое, мягкое), `difference` - вычитание (жесткое, мягкое)
+ Модель освещения по Ламберту - ф-ция `getLight`
+ Анти-алиасинг (AAX1 и AAX4) `kernel2D_RayMarchAAX1` и `kernel2D_RayMarchAAX4`
+ Мягкие тени - ф-ция `getSoftShadow`
+ Настройка параметров камеры через изменение соответствующего json файла ф-ция `readCamera`, где `position` - позиция камеры, `lookAt` - направление взгляда, `FOV` - угол обзора
+ Отражения - `specular` в ф-ции `getLight`
+ Реализован `ambient occlucsion` - ф-ция `getAmbientOcclusion`
+ Туман на большом расстоянии от камеры
+ Для переноса на GPU был использован `kernel_slicer`

### Сцена

Сцена содержит в себе несколько примитивов и фракталов:
   * Сцена выполнена в синих оттенках
   * Основу сцены составляет пересечение куба со сферой
   * В центре находится губка Менгера (основной объект в задании) в пересечении со сферой
   * Над ними в воздухе находится второй фрактал - мн-во Мандельброта при степени 7
   * Ближе к камере находится сфера, которая мягко объеденина с плоскостью
   * Плоскость имеет шахматную раскраску
   * Каждый примитив имеет уникальный цвет

## Производительность

Результатом программы является файлы вида `out_gpu\cpu_width x height.bmp` , лежащие в папке `images`

Все расчеты проводились на ноутбуке - HP Victus / `Ryzen 5 5600H` / `GeForce RTX 3050Ti 4GB` / 16GB

Выбранные разрешения: `1920x1080`, `2560x1440`, `3840×2160`

Все вычисления производились с включенным анти-алиасингом - `AAX4`

| Вычислитель/Разрешение      | 1920x1080      | 2560x1440      | 3840×2160      |
| --------------------------- | -------------- | -------------- | -------------- |
| CPU (1 поток)               | 125.9 c        | 232.847 с      | 502.520 с      |
| CPU (многопоточный)         | 20.4042 с      | 37.7673 с      | 84.6729 с      |
| GPU (без учета копирования) | 0.41829 с      | 0.702651 с     | 1.51245 с      |
| GPU (с учетом копирования)  | 0.453792 с     | 0.762365 с     | 2.64625 с      |
| GPU (время копирования)     | 0.035502 с     | 0.059714 с     | 1.1338 с       |

